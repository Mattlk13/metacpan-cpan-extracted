#!/usr/bin/perl -w -s

## use utf8::all;
use Data::Dumper;

our ($all,$w,$max,$pdf, $o, $n, $a,$debug);

$max //= 500;
$max = 1000000000 if ($max == 0 or $all);

use strict;
use warnings;

my $p = shift;

$p = qr{\b$p\b} if $w;

use XML::TMX;
use XML::TMX::Reader;

our ($icons);

my $tmx = shift;
my $tmx_obj = XML::TMX::Reader->new($tmx);


 $tmx_obj->for_tu( 
    { patt => $p, 
      gen_tu=> $max, 
      n => $n || 0,
      output => $o || undef }, #### "__tmxgrep.tmx" 
    sub { my($tu,$at) = @_;
         print STDERR  Dumper($tu,$at) if $main::debug; 
#         print STDERR  "."; 
          if($main::a){
            for my $k(keys %$tu){
              for(keys %{$tu->{$k}}){
                $tu->{$k}{$_} =~ s!($p)!=($1)=!g;
              }
            }
          }
          return $tu;
    }
 );

if($pdf){ system("xpdf-tmx __.tmx");}


__END__

=head1 NAME

tmxgrep - grep translation units in a TMX file

=head1 SYNOPSIS

 tmxgrep <perlregexp> file.tmx
 options:
   -pdf        -- output is transformed in a PDF file 
   -max=300    -- extract up to 300 TU (def=500)
   -max=0      -- all matches
   -all        -- all matches
   -a          -- annotate matches with '==(...)'
   -o=out.tmx  -- define output file (defaut= STDOUT)
   -n          -- print original TU number (eg: <tu n="35">)

=head1 DESCRIPTION

Creates a TMX file with the tranlation units tha macth the provided
regular expression.


=head1 AUTHOR

J.Joao Almeida, jj@di.uminho.pt

=head1 SEE ALSO

perl(1).

xpdf-tmx

XML::TMX

TMX

=cut      

