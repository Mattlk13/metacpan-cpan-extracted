<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:_networkd@osx357.sd.apple.com" />
</head>

<body style="background-color: white">



<ul id="index">
  <li><a href="#SYNOPSIS">SYNOPSIS</a>
    <ul>
      <li><a href="#OAUTH-CREDENTIALS-FILE-TO-ACCESS-SERVCICES">OAUTH CREDENTIALS FILE TO ACCESS SERVCICES</a></li>
      <li><a href="#api_query">api_query</a></li>
      <li><a href="#has_scope_to_access_api_endpoint">has_scope_to_access_api_endpoint</a></li>
      <li><a href="#methods_available_for_google_api_id">methods_available_for_google_api_id</a></li>
      <li><a href="#list_of_available_google_api_ids">list_of_available_google_api_ids</a></li>
    </ul>
  </li>
  <li><a href="#KEY-FEATURES">KEY FEATURES</a>
    <ul>
      <li><a href="#TODO">TODO:</a></li>
    </ul>
  </li>
  <li><a href="#SEE-ALSO">SEE ALSO</a></li>
</ul>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<p>Module aspires to simplify usage of Google API Services using an OAUTH2&#39;d client. Aim is to streamline endpoint access without forcing an additional opinionated abstraction layer that imposes unecessary congnitive load. Users of the module should be able to access all Google Services and either use helper features or fully construct requests in a way that is as portable to alternative approaches as possible.</p>

<pre><code>    ## use goauth CLI helper to create the OATH credentials file ( see perldoc goauth )

    use WebService::GoogleAPI::Client;
    use Data::Dumper;

    my $gapi = WebService::GoogleAPI::Client-&gt;new(debug =&gt; 0); # my $gapi = WebService::GoogleAPI::Client-&gt;new(access_token =&gt; &#39;&#39;);
    my $user = &#39;peter@pscott.com.au&#39;; # full gmail or G-Suite email

    $gapi-&gt;auth_storage-&gt;setup({type =&gt; &#39;jsonfile&#39;, path =&gt; &#39;./gapi.json&#39; }); # by default

    $gapi-&gt;user($user);       ## allows to select user configuration by google auth&#39;d email address
    $gapi-&gt;do_autorefresh(1); ## refresh auth token with refresh token if auth session has expired</code></pre>

<h2 id="OAUTH-CREDENTIALS-FILE-TO-ACCESS-SERVCICES">OAUTH CREDENTIALS FILE TO ACCESS SERVCICES</h2>

<p>While I personally find the goauth tool useful to create local auth credentials and can work with the code, you may find it more useful to do it all yourself using an approach like at https://blog.ludin.org/2017/01/15/using-google-apis-with-perl-part-3-simplicity/</p>

<p>This code still retains a lot of the bad smells of the parents.</p>

<h2 id="api_query">api_query</h2>

<p>query Google API with option to validate request before submitting</p>

<p>handles user auth token inclusion in request headers and refreshes token if required and possible</p>

<p>Required params: method, route</p>

<p>Optional params: api_endpoint_id</p>

<p>$self-&gt;access_token must be valid</p>

<p>Examples of usage:</p>

<pre><code>  $gapi-&gt;api_query({
      method =&gt; &#39;get&#39;,
      path =&gt; &#39;https://www.googleapis.com/calendar/users/me/calendarList&#39;,
    });

  $gapi-&gt;api_query({
      method =&gt; &#39;post&#39;,
      path =&gt; &#39;https://www.googleapis.com/calendar/v3/calendars/&#39;.$calendar_id.&#39;/events&#39;,
      options =&gt; { key =&gt; value }
  }

  ## if provide the Google API Endpoint to inform pre-query validation
  say $gapi_agent-&gt;api_query(
      api_endpoint_id =&gt; &#39;gmail.users.messages.send&#39;,
      options    =&gt; { raw =&gt; encode_base64( 
                                            Email::Simple-&gt;create( header =&gt; [To =&gt; $user, From =&gt; $user, Subject =&gt;&quot;Test email from $user&quot;,], 
                                                                    body   =&gt; &quot;This is the body of email from $user to $user&quot;, )-&gt;as_string 
                                          ), 
                    },
  )-&gt;to_string; ##

  print  $gapi_agent-&gt;api_query(
            api_endpoint_id =&gt; &#39;gmail.users.messages.list&#39;, ## auto sets method to GET, path to &#39;https://www.googleapis.com/calendar&#39;
          )-&gt;to_string;
  #print Dumper $r;


  NB: including the version in the API Endpoint Spec is not supported .. yet? eg gmail:v1.users.messages.list .. will always use the latest stable version


  if the pre-query validation fails then a 418 - I&#39;m a Teapot error response is returned with the 
  body containing the specific description of the errors ( Tea Leaves ;^) ).   </code></pre>

<p>Returns <a>Mojo::Message::Response</a> object</p>

<h2 id="has_scope_to_access_api_endpoint"><code>has_scope_to_access_api_endpoint</code></h2>

<p>Given an API Endpoint such as &#39;gmail.users.settings.sendAs.get&#39; returns 1 iff user has scope to access</p>

<p>Returns 0 if scope to access is not available to the user.</p>

<p>warns and returns 0 on error ( eg user or config not specified etc )</p>

<h2 id="methods_available_for_google_api_id"><code>methods_available_for_google_api_id</code></h2>

<p>Returns a hashref keyed on the Google service API Endpoint in dotted format. The hashed content contains a structure representing the corresponding discovery specification for that method ( API Endpoint )</p>

<pre><code>    methods_available_for_google_api_id(&#39;gmail.users.settings.delegates.get&#39;)</code></pre>

<p>TODO: consider ? refactor to allow parameters either as a single api id such as &#39;gmail&#39; as well as the currently accepted hash keyed on the api and version</p>

<p>SEE ALSO: The following methods are delegated through to Client::Discovery - see perldoc WebService::Client::Discovery for detils</p>

<pre><code>  get_method_meta 
  discover_all 
  extract_method_discovery_detail_from_api_spec 
  get_api_discovery_for_api_id</code></pre>

<h2 id="list_of_available_google_api_ids"><code>list_of_available_google_api_ids</code></h2>

<p>Returns an array list of all the available API&#39;s described in the API Discovery Resource that is either fetched or cached in CHI locally for 30 days.</p>

<h1 id="KEY-FEATURES">KEY FEATURES</h1>

<dl>

<dt id="API-Discovery-with-local-caching-using-CHI-File">API Discovery with local caching using CHI File</dt>
<dd>

</dd>
<dt id="OAUTH-app-credentials-client_id-client_secret-scope-users-access_token-and-refresh_tokens-stored-in-local-file-default-name-gapi.json">OAUTH app credentials (client_id, client_secret, scope, users access_token and refresh_tokens) stored in local file (default name = gapi.json)</dt>
<dd>

</dd>
<dt id="access_token-refreshes-when-expires-if-user-has-refresh_token-saving-refreshed-token-back-to-json-file">access_token refreshes when expires (if user has refresh_token) saving refreshed token back to json file</dt>
<dd>

</dd>
<dt id="helper-api_query-to-streamline-request-composition-without-preventing-manual-construction-if-preferred">helper api_query to streamline request composition without preventing manual construction if preferred.</dt>
<dd>

</dd>
<dt id="CLI-tool-goauth-with-lightweight-http-server-to-simplify-OAuth2-configuration-sccoping-authorization-and-obtaining-access_-and-refresh_-tokensn-from-users">CLI tool (<i>goauth</i>) with lightweight http server to simplify OAuth2 configuration, sccoping, authorization and obtaining access_ and refresh_ tokensn from users</dt>
<dd>

</dd>
</dl>

<h2 id="TODO">TODO:</h2>

<dl>

<dt id="Refactor-AuthStorage-and-Credentials-modules---include-capability-to-handle-service-accounts-credentials-which-are-not-currently-supported.-See-https:-gist.github.com-gsainio-6322375">Refactor AuthStorage and Credentials modules - include capability to handle service accounts credentials which are not currently supported. See https://gist.github.com/gsainio/6322375</dt>
<dd>

</dd>
<dt id="standardise-terminology-in-documentation-and-code">standardise terminology in documentation and code</dt>
<dd>

</dd>
<dt id="include-POD-for-delegated-methods">include POD for delegated methods</dt>
<dd>

</dd>
<dt id="basic-CLI-to-query-API-Discovery-data-Potentially-with-OPEN-Swagger-Output-option">basic CLI to query API Discovery data ( Potentially with OPEN/Swagger Output option )</dt>
<dd>

</dd>
</dl>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<ul>

<li><p><a>&quot;/www.blog.google/products/google-cloud/&quot; in Google Cloud Blog https:</a>&gt;</p>

</li>
<li><p><a>Moo::Google</a> - The original code base later forked into <a>WebService::Google</a> by Steve Dondley. This is where this code started believing that I could clean it up. In hindisght it would have been much easier to start from scratch.</p>

</li>
<li><p><a>&quot;/github.com/APIs-guru/google-discovery-to-swagger&quot; in Google Swagger API https:</a></p>

</li>
<li><p><a>OAuth2::Client::Google</a> - Perl 6 OAuth2 Client</p>

</li>
</ul>


</body>

</html>


