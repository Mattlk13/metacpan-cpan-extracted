(function(){var a=angular.module("llngManager",["ui.tree","ui.bootstrap","llApp","ngCookies"]);a.controller("TreeCtrl",["$scope","$http","$location","$q","$uibModal","$translator","$cookies","$htmlParams",function(m,s,g,p,j,i,l,f){m.links=links;m.menu=f.menu;m.menulinks=menulinks;m.staticPrefix=staticPrefix;m.formPrefix=formPrefix;m.availableLanguages=availableLanguages;m.waiting=true;m.showM=false;m.showT=false;m.form="home";m.currentCfg={};m.confPrefix=confPrefix;m.message={};m.result="";m.helpUrl="start.html#configuration";m.setShowHelp=function(v){if(typeof v==="undefined"){v=!m.showH}m.showH=v;var c=new Date(Date.now());c.setFullYear(c.getFullYear()+1);l.put("showhelp",(v?"true":"false"),{expires:c})};m.showH=(l.get("showhelp")==="false"?false:true);if(typeof m.showH==="undefined"){m.setShowHelp(true)}var o=function(c){var w=c.status;var v=c.statusText;m.waiting=false;if(w==403){m.message={title:"forbidden",message:"",items:[]}}else{if(w==401){console.log("Authentication needed");m.message={title:"authenticationNeeded",message:"__waitOrF5__",items:[]}}else{if(w==400){m.message={title:"badRequest",message:v}}else{if(w>0){m.message={title:"badRequest",message:v}}else{m.message={title:"networkProblem",message:""}}}}}return m.showModal("message.html")};m.showModal=function(v,x){var c=j.open({templateUrl:v,controller:"ModalInstanceCtrl",size:"lg",resolve:{elem:function(){return function(y){return m[y]}},set:function(){return function(z,y){m[z]=y}},init:function(){return x}}});var w=p.defer();c.result.then(function(y){m.message={title:"",message:"",items:[]};w.resolve(y)},function(y){m.message={title:"",message:"",items:[]};w.reject(y)});return c.result};m.menuClick=function(c){if(c.popup){window.open(c.popup)}else{if(!c.action){c.action=c.title}switch(typeof c.action){case"function":c.action(m.currentNode,m);break;case"string":m[c.action]();break;default:console.log(typeof c.action)}}m.showM=false};m.home=function(){m.form="home";m.showM=false};var d=function(v){m.message={title:"",message:"",items:[]};if(v.message&&v.message=="__needConfirmation__"){m.confirmNeeded=true}if(v.message){m.message.message=v.message}if(v.details){for(var c in v.details){if(c!="__changes__"){m.message.items.push({message:c,items:v.details[c]})}}}m.waiting=false;if(v.result==1){g.path("/confs/");m.message.title="successfullySaved"}else{m.message.title="saveReport"}m.showModal("message.html")};m.downloadConf=function(){window.open(m.confPrefix+m.currentCfg.cfgNum+"?full")};m.save=function(){m.showModal("save.html").then(function(){m.waiting=true;m.data.push({id:"cfgLog",title:"cfgLog",data:m.result?m.result:""});s.post(confPrefix+"?cfgNum="+m.currentCfg.cfgNum+(m.forceSave?"&force=1":""),m.data).then(function(c){m.data.pop();d(c.data)},function(c){o(c);m.data.pop()})},function(){console.log("Saving canceled")});m.showM=false};m.saveRawConf=function(c){m.waiting=true;s.post(confPrefix+"/raw",c).then(function(v){d(v.data)},o)};m.restore=function(){m.currentNode=null;m.form="restore"};m.cancel=function(){m.currentNode.data=null;m.getKey(m.currentNode)};var k=1;m._findContainer=function(){return m._findScopeContainer().$modelValue};m._findScopeContainer=function(){var c=m.currentScope;while(!c.$modelValue.type.match(/Container$/)){c=c.$parentNodeScope}return c};m._findScopeByKey=function(c){var v=m.currentScope;while(!(v.$modelValue.title===c)){v=v.$parentNodeScope}return v};m.newGrantRule=function(){var v=m._findContainer();var c=v.nodes.length;var w=c>0?c-1:0;v.nodes.splice(w,0,{id:v.id+"/n"+(k++),title:"New rule",re:"1",comment:"New rule",data:"Message",type:"grant"})};m.newRule=function(){var v=m._findContainer();var c=v.nodes.length;var w=c>0?c-1:0;v.nodes.splice(w,0,{id:v.id+"/n"+(k++),title:"New rule",re:"^/new",comment:"New rule",data:"accept",type:"rule"})};m.newPost=function(){var c=m._findContainer();c.nodes.push({id:c.id+"/n"+(k++),title:"/absolute/path/to/form",data:{},type:"post"})};m.newPostVar=function(){if(typeof m.currentNode.data.vars==="undefined"){m.currentNode.data.vars=[]}m.currentNode.data.vars.push(["var1","$uid"])};m.newAuthChoice=function(){var c=m._findContainer();c.nodes.push({id:c.id+"/n"+(k++),title:"1_Key",data:["Null","Null","Null"],type:"authChoice"});m.execFilters(m._findScopeByKey("authParams"))};m.newHashEntry=function(){var c=m._findContainer();c.nodes.push({id:c.id+"/n"+(k++),title:"new",data:"",type:"keyText"})};m.newCat=function(){var c=m.currentScope;if(c.$modelValue.type=="menuApp"){c=c.$parentNodeScope}c.$modelValue.nodes.push({id:c.$modelValue.id+"/n"+(k++),title:"New category",type:"menuCat",nodes:[]})};m.newApp=function(){var c=m.currentScope;if(c.$modelValue.type=="menuApp"){c=c.$parentNodeScope}c.$modelValue.nodes.push({id:c.$modelValue.id+"/n"+(k++),title:"New application",type:"menuApp",data:{description:"New app description",uri:"https://test.example.com/",logo:"network.png",display:"auto"}})};m.addHost=function(){var c=m.currentNode;if(!c.data){c.data=[]}c.data.push({k:"newHost",h:[{k:"key",v:"uid"}]})};m.addSamlAttribute=function(){var c=m._findContainer();c.nodes.push({id:c.id+"/n"+(k++),title:"new",type:"samlAttribute",data:[0,"New","",""]})};m.addVhost=function(){var c=m.domain?("."+m.domain.data):".example.com";m.message={title:"virtualHostName",field:"hostname"};m.showModal("prompt.html",c).then(function(){var v=m.result;if(v){return m.addTemplateNode(v,"virtualHost")}})};m.duplicateVhost=function(){var c=m.domain?("."+m.domain.data):".example.com";m.message={title:"virtualHostName",field:"hostname"};m.showModal("prompt.html",c).then(function(){var v=m.result;return m.duplicateNode(v,"virtualHost",m.currentNode.title)})};m.addSamlIDP=function(){m.newTemplateNode("samlIDPMetaDataNode","samlPartnerName","idp-example")};m.addSamlSP=function(){m.newTemplateNode("samlSPMetaDataNode","samlPartnerName","sp-example")};m.addOidcOp=function(){m.newTemplateNode("oidcOPMetaDataNode","oidcOPName","op-example")};m.addOidcRp=function(){m.newTemplateNode("oidcRPMetaDataNode","oidcRPName","rp-example")};m.newTemplateNode=function(c,w,v){m.message={title:w,field:"name"};m.showModal("prompt.html",v).then(function(){var x=m.result;if(x){m.addTemplateNode(x,c)}})};m.addTemplateNode=function(c,x){var w=m.currentScope;while(w.$modelValue.title!=x+"s"){w=w.$parentNodeScope}var v={id:x+"s/new__"+c,title:c,type:x,nodes:templates(x,"new__"+c)};r(v.nodes);w.$modelValue.nodes.push(v);w.expand();return v};var r=function(v){var c,x,w;for(w=0,c=v.length;w<c;w++){x=v[w];if(x.cnodes&&x["default"]){delete x.cnodes;x._nodes=x["default"]}if(x._nodes){r(x._nodes)}else{if(x["default"]||x["default"]===0){x.data=x["default"]}}}return v};var t=function(v){var w=p.defer();var c=p.defer();if(v._nodes){n(v);w.resolve()}else{if(v.cnodes){h(v).then(function(){w.resolve()})}else{if(v.nodes||v.data){w.resolve()}else{m.getKey(v).then(function(){w.resolve()})}}}w.promise.then(function(){var x=[];if(v.nodes){v.nodes.forEach(function(y){x.push(t(y))})}p.all(x).then(function(){c.resolve()})});return c.promise};m.duplicateNode=function(c,x,v){var w=m.currentScope;t(m.currentNode).then(function(){while(w.$modelValue.title!=x+"s"){w=w.$parentNodeScope}var y=JSON.parse(JSON.stringify(m.currentNode).replace(new RegExp(v,"g"),"new__"+c));y.id=x+"s/new__"+c;y.title=c;w.$modelValue.nodes.push(y);return y})};m.del=function(c,v){c.splice(v,1)};m.deleteEntry=function(){var c=m.currentScope.$parentNodeScope;m.currentScope.remove();m.displayForm(c)};m.down=function(){var y=m.currentNode.id;var x=m.currentScope.$parentNodeScope.$modelValue;var w=x.nodes.length;for(var v=0;v<x.nodes.length;v++){if(x.nodes[v].id==y){w=v}}if(w<x.nodes.length-1){var c=x.nodes[w];x.nodes[w]=x.nodes[w+1];x.nodes[w+1]=c}};m.up=function(){var y=m.currentNode.id;var x=m.currentScope.$parentNodeScope.$modelValue;var w=-1;for(var v=0;v<x.nodes.length;v++){if(x.nodes[v].id==y){w=v}}if(w>0){var c=x.nodes[w];x.nodes[w]=x.nodes[w-1];x.nodes[w-1]=c}};m.translateTitle=function(c){return i.translateField(c,"title")};m.translateP=i.translateP;m.translate=i.translate;m.inSelect=function(v){for(var c=0;c<m.currentNode.select.length;c++){if(m.currentNode.select[c].k==v){return true}}return false};m.changeRuleTitle=function(c){if(c.comment.length>0){c.title=c.comment}else{c.title=c.re}};m.filters={};m.execFilters=function(v){v=v?v:m;for(var c in m.filters){if(m.filters.hasOwnProperty(c)){filterFunctions[c](v,p,m.filters[c])}}};m.stoggle=function(c){var v=c.$modelValue;n(v);c.toggle()};var n=function(c){["nodes","nodes_cond"].forEach(function(v){if(c["_"+v]){c[v]=[];c["_"+v].forEach(function(w){c[v].push(w)});delete c["_"+v]}});if(c._nodes_filter){if(c.nodes){c.nodes.forEach(function(v){v.onChange=m.execFilters})}m.filters[c._nodes_filter]=c;m.execFilters()}};m.toggle=function(c){c.toggle()};m.download=function(c){var v=c.$modelValue;return h(v)};var h=function(c){var v=p.defer();v.notify("Trying to get datas");m.waiting=true;s.get(confPrefix+m.currentCfg.cfgNum+"/"+c.cnodes).then(function(w){var x=w.data;if(!x){v.reject("Empty response from server")}else{if(x.error){if(x.error.match(/setDefault$/)){if(c["default"]){c.nodes=c["default"].slice(0)}else{c.nodes=[]}delete c.cnodes;v.resolve("Set data to default value")}else{v.reject("Server return an error: "+x.error)}}else{delete c.cnodes;if(!c.type){c.type="keyTextContainer"}c.nodes=[];x.forEach(function(y){if(y.template){y._nodes=templates(y.template,y.title)}c.nodes.push(y)});v.resolve("OK")}}m.waiting=false},function(w){o(w);v.reject("")});return v.promise};m.openCnode=function(c){m.download(c).then(function(){c.toggle()})};var u=function(c){while(!c.$modelValue.help&&c.$parentNodeScope){c=c.$parentNodeScope}m.helpUrl=c.$modelValue.help||"start.html#configuration"};m.displayForm=function(c){var v=c.$modelValue;if(v.cnodes){m.download(c)}if(v._nodes){m.stoggle(c)}m.currentNode=v;m.currentScope=c;var w;if(v.type){w=v.type}else{w="text"}if(v.nodes||v._nodes||v.cnodes){m.form=w!="text"?w:"mini"}else{m.form=w;m.getKey(v)}if(v.type&&v.type=="simpleInputContainer"){v.nodes.forEach(function(x){m.getKey(x)})}m.showT=false;u(c)};m.keyWritable=function(c){var v=c.$modelValue;return v.type&&v.type.match(/^(authChoice|keyText|virtualHost|rule|menuCat|menuApp|samlAttribute)$/)?true:false};m.newRSAKey=function(){m.showModal("password.html").then(function(){m.waiting=true;var v=m.currentNode;var c=m.result;s.post(confPrefix+"/newRSAKey",{password:c}).then(function(w){var x=w.data;v.data[0].data=x["private"];v.data[1].data=c;v.data[2].data=x["public"];m.waiting=false},o)},function(){console.log("New key cancelled")})};m.newRSAKeyNoPassword=function(){m.waiting=true;var c=m.currentNode;s.post(confPrefix+"/newRSAKey",{password:""}).then(function(v){var w=v.data;c.data[0].data=w["private"];c.data[1].data=w["public"];m.waiting=false},o)};m.getKey=function(w){var x=p.defer();if(!w.data){m.waiting=true;if(w.get&&typeof(w.get)=="object"){w.data=[];var v=[];for(var c=0;c<w.get.length;c++){w.data[c]=({title:w.get[c],id:w.get[c]});v.push(m.getKey(w.data[c]))}p.all(v).then(function(){x.resolve(w.data)},function(y){x.reject(e);m.waiting=false})}else{s.get(confPrefix+m.currentCfg.cfgNum+"/"+(w.get?w.get:w.title)).then(function(y){var z=y.data;if((z.value===null||(z.error&&z.error.match(/setDefault$/)))&&w["default"]!==null){w.data=w["default"]}else{w.data=z.value}if(w.type&&w.type.match(/^(int|bool|trool)$/)){w.data=parseInt(w.data)}else{if(w.type&&w.type.match(/^(saml(Service|Assertion)|blackWhiteList)$/)&&!(typeof w.data==="object")){w.data=w.data.split(";")}}m.waiting=false;x.resolve(w.data)},function(y){x.reject(e);o(y)})}}else{x.resolve(w.data)}return x.promise};var b=function(v,c,w){var x=c.match(new RegExp("#/confs/(latest|[0-9]+)"));if(x===null){g.path("/confs/latest")}else{console.log("Trying to get cfg number "+x[1]);m.getCfg(x[1])}};m.$on("$locationChangeSuccess",b);m.getCfg=function(c){if(m.currentCfg.cfgNum!=c){s.get(confPrefix+c).then(function(v){var w=v.data;m.currentCfg=w;var x=new Date(m.currentCfg.cfgDate*1000);m.currentCfg.date=x.toLocaleString();console.log("Metadatas of cfg "+c+" loaded");g.path("/confs/"+c);m.init()},function(v){o(v).then(function(){m.currentCfg.cfgNum=0;m.init()})})}else{m.waiting=false}};m.getLanguage=function(c){m.lang=c;m.form="white";m.init();m.showM=false};m.init=function(){var c;m.waiting=true;m.data=[];m.confirmNeeded=false;m.forceSave=false;p.all([i.init(m.lang),s.get(staticPrefix+"struct.json").then(function(v){c=v.data;console.log("Structure loaded")})]).then(function(){console.log("Starting structure binding");m.data=c;c=null;if(m.currentCfg.cfgNum!=0){setScopeVars(m)}else{m.message={title:"emptyConf",message:"__zeroConfExplanations__"};m.showModal("message.html")}m.form="home";m.waiting=false},o)};var q=g.path().match(new RegExp("^/confs/(latest|[0-9]+)"));if(!q){console.log("Redirecting to /confs/latest");g.path("/confs/latest")}m.replaceContentByUrl=function(v,c){m.waiting=true;s.post(scriptname+"prx",{url:c}).then(function(w){v.data=w.data.content;m.waiting=false},o)};m.replaceContent=function(v,c){v.data=c};m.saveAs=function(w,v,c){saveAs(new Blob([w],{type:v}),c)};m.saveAsPem=function(v,c){c.saveAs(v.data[0].data+"\n"+v.data[2].data,"application/x-pem-file",v.title+".pem")};m.saveAsText=function(v,c){c.saveAs(v.data,"text/plain",v.title+".txt")}}])})();